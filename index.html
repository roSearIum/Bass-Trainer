<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Bassist's Game</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      text-align:center;
      margin:0; padding:30px 10px;
      background:#000; color:#fff;
    }
    h1 { font-size: 42px; margin: 0 0 10px; }
    #note { font-size: 72px; margin:20px 0; color: #e74c3c; font-weight: 800; letter-spacing: 1px; }
    #result { font-size: 28px; margin:10px 0 6px; min-height: 34px; }
    #score { font-size: 22px; margin:16px 0; }
    #timer { font-size: 20px; color: #ffcc00; margin:6px 0 8px; min-height: 24px; }
    .controls { margin: 8px 0 14px; display:flex; gap:8px; justify-content:center; flex-wrap: wrap; }
    select, button {
      padding:10px 16px; font-size:18px; border-radius:8px; border:1px solid #333;
      background:#111; color:#fff; cursor:pointer;
    }
    button:hover, select:hover { background:#151515; }
    .progress-container { width: 320px; height: 20px; background: #333; margin: 10px auto; border-radius: 10px; overflow: hidden; }
    .progress-bar { height: 100%; background: #e74c3c; width: 100%; transition: width 1s linear; }
    .status { font-size:14px; color:#aaa; margin-top:10px; min-height:18px; }
    .error { color:#ff6b6b; }
    .ok    { color:#7fffd4; }
  </style>
</head>
<body>
  <h1>Bassist's Game</h1>

  <div class="controls">
    <label>
      Instrument:
      <select id="instrument">
        <option value="4">Bass 4 Strings (EADG)</option>
        <option value="5" selected>Bass 5 Strings (BEADG)</option>
      </select>
    </label>

    <label>
      Difficulty:
      <select id="difficulty">
        <option value="10000">Very Easy (10s)</option>
        <option value="6000">Easy (6s)</option>
        <option value="4000">Intermediate (4s)</option>
        <option value="3000" selected>Advanced (3s)</option>
        <option value="2000">Ass Kicker (2s)</option>
      </select>
    </label>

    <button id="startBtn">Start Game</button>
    <button id="pauseBtn">Pause / Resume</button>
  </div>

  <div id="note">Press Start</div>
  <div id="result"></div>
  <div id="timer"></div>
  <div class="progress-container"><div class="progress-bar" id="progressBar"></div></div>
  <div id="score"></div>
  <div id="status" class="status"></div>

  <!-- Main app (no inline handlers; buttons bound via addEventListener) -->
  <script type="module">
    const statusEl = document.getElementById('status');

    // Dynamically import Pitchy and start app
    let PitchDetector;
    try {
      ({ PitchDetector } = await import('https://cdn.jsdelivr.net/npm/pitchy@4.0.1/dist/pitchy.esm.js'));
      statusEl.innerText = 'Pitchy loaded.';
      statusEl.classList.add('ok');
    } catch (e) {
      statusEl.innerText = 'Error: Could not load Pitchy. Check your connection or CDN.';
      statusEl.classList.add('error');
      console.error(e);
      // Do not proceed without pitchy
      throw e;
    }

    // ---------- App Code ----------
    const noteNames = ["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"];
    const TOL_CENTS   = 35;   // ±35 cents
    const PREGAIN_DB  = 2.0;  // ~ +6dB analysis gain
    const CLARITY_MIN = 0.6;  // accept a bit noisier frames
    const DETECTOR_SIZE = 2048;

    const instrumentSel = document.getElementById('instrument');
    const difficultySel = document.getElementById('difficulty');
    const startBtn = document.getElementById('startBtn');
    const pauseBtn = document.getElementById('pauseBtn');

    const noteEl   = document.getElementById('note');
    const resultEl = document.getElementById('result');
    const scoreEl  = document.getElementById('score');
    const timerEl  = document.getElementById('timer');
    const barEl    = document.getElementById('progressBar');

    let fretboard = [];
    let audioCtx, analyser, dataArray, source, detector, preGain;
    let target = null, round = 0, score = 0;
    let paused = false, gameActive = false, timeoutHandle = null, timerInterval = null, pollHandle = null;
    let timeLeft = 0, totalTime = 0;
    let tmpBuffer; // analyser buffer

    function buildFretboard(type){
      const strings = (type==="5")
        ? [ {name:"B",freq:30.87}, {name:"E",freq:41.20}, {name:"A",freq:55.00}, {name:"D",freq:73.42}, {name:"G",freq:98.00} ]
        : [ {name:"E",freq:41.20}, {name:"A",freq:55.00}, {name:"D",freq:73.42}, {name:"G",freq:98.00} ];
      fretboard = [];
      for (let s of strings){
        for (let fret=0; fret<=12; fret++){
          const freq = s.freq * Math.pow(2, fret/12);
          const n = noteNames[Math.round(12 * Math.log2(freq/16.35)) % 12];
          fretboard.push({string:s.name, fret:fret, note:n, freq:freq});
        }
      }
    }

    async function initMic(){
      if (audioCtx) return;
      try {
        audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        source = audioCtx.createMediaStreamSource(stream);

        preGain = audioCtx.createGain();
        preGain.gain.value = PREGAIN_DB;

        analyser = audioCtx.createAnalyser();
        analyser.fftSize = 4096; // better for lows
        tmpBuffer = new Float32Array(analyser.fftSize);

        dataArray = new Float32Array(DETECTOR_SIZE);
        source.connect(preGain);
        preGain.connect(analyser);

        detector = PitchDetector.forFloat32Array(DETECTOR_SIZE);

        statusEl.innerText = 'Mic ready.';
        statusEl.classList.add('ok');
      } catch (err) {
        statusEl.innerText = 'Mic access denied or failed. Check browser permissions.';
        statusEl.classList.add('error');
        console.error(err);
        throw err;
      }
    }

    function midiFromFreq(f){ return 69 + 12 * Math.log2(f/440); }
    function freqFromMidi(m){ return 440 * Math.pow(2, (m-69)/12); }
    function noteIndexFromMidi(m){ return ((Math.round(m) - 12) % 12 + 12) % 12; }

    function startGame(){
      buildFretboard(instrumentSel.value);
      score = 0; round = 0; gameActive = true; paused = false;
      scoreEl.innerText = `Score: 0 / 0`;
      initMic().then(nextRound).catch(()=>{ /* already messaged */ });
    }

    function nextRound(){
      if (!gameActive || paused) return;
      if (round >= 35){
        noteEl.innerText   = "Game Over!";
        resultEl.innerText = `Final Score: ${score} / ${round}`;
        timerEl.innerText  = "";
        barEl.style.width  = "0%";
        stopPolling();
        gameActive = false;
        return;
      }
      target = fretboard[Math.floor(Math.random()*fretboard.length)];
      round++;
      noteEl.innerText   = `${target.note} on ${target.string}`;
      resultEl.innerText = "Play now!";

      totalTime = parseInt(difficultySel.value, 10);
      timeLeft = totalTime/1000;
      timerEl.innerText = `Time left: ${timeLeft}s`;
      barEl.style.width = "100%";

      clearInterval(timerInterval);
      timerInterval = setInterval(()=>{
        timeLeft -= 1;
        if (timeLeft>=0){
          timerEl.innerText = `Time left: ${timeLeft}s`;
          barEl.style.width = (timeLeft*1000/totalTime*100) + "%";
        }
      },1000);

      clearTimeout(timeoutHandle);
      timeoutHandle = setTimeout(()=>{
        resultEl.innerText = "⏰ Timeout / No sound";
        playBeep("wrong");
        stopPolling();
        setTimeout(nextRound,1000);
      }, totalTime);

      startPolling();
    }

    function startPolling(){
      stopPolling();
      pollHandle = setInterval(sampleAndJudge, 120);
    }
    function stopPolling(){
      if (pollHandle){ clearInterval(pollHandle); pollHandle=null; }
    }

    function sampleAndJudge(){
      if (!gameActive || paused) return;

      analyser.getFloatTimeDomainData(tmpBuffer);
      const start = Math.floor((tmpBuffer.length - DETECTOR_SIZE)/2);
      for (let i=0;i<DETECTOR_SIZE;i++) dataArray[i] = tmpBuffer[start + i];

      const [pitch, clarity] = detector.findPitch(dataArray, audioCtx.sampleRate);
      if (!pitch || !isFinite(pitch) || clarity < CLARITY_MIN) return;

      const playedMidi = Math.round(midiFromFreq(pitch));
      const playedFreqNearest = freqFromMidi(playedMidi);
      const playedIndex = noteIndexFromMidi(playedMidi);
      const targetIndex = noteNames.indexOf(target.note);
      const centsErr = 1200 * Math.log2(pitch / playedFreqNearest);

      if (playedIndex === targetIndex && Math.abs(centsErr) <= TOL_CENTS){
        score++;
        resultEl.innerText = `✅ Correct! ${target.note} (~${pitch.toFixed(1)} Hz)`;
        scoreEl.innerText  = `Score: ${score} / ${round}`;
        playBeep("correct");
        clearTimeout(timeoutHandle);
        clearInterval(timerInterval);
        stopPolling();
        setTimeout(nextRound, 400);
      } else {
        resultEl.innerText = `❌ Wrong (~${noteNames[playedIndex]} • ${pitch.toFixed(1)} Hz). Target: ${target.note}`;
        if (!sampleAndJudge._lastWrong || performance.now() - sampleAndJudge._lastWrong > 900) {
          playBeep("wrong");
          sampleAndJudge._lastWrong = performance.now();
        }
      }
    }

    function togglePause(){
      paused = !paused;
      if (paused){
        clearTimeout(timeoutHandle);
        clearInterval(timerInterval);
        stopPolling();
        resultEl.innerText = "⏸ Paused";
      } else {
        resultEl.innerText = "▶ Resumed";
        setTimeout(nextRound,500);
      }
    }

    function playBeep(type="correct"){
      const ctx = new (window.AudioContext || window.webkitAudioContext)();
      const osc = ctx.createOscillator();
      const gain = ctx.createGain();
      osc.connect(gain);
      gain.connect(ctx.destination);
      osc.type = "sine";
      if (type==="correct"){ osc.frequency.value = 880; gain.gain.value = 0.1; }
      else { osc.frequency.value = 220; gain.gain.value = 0.12; }
      osc.start();
      osc.stop(ctx.currentTime + 0.15);
    }

    // Bind buttons AFTER script loads (no inline handlers)
    startBtn.addEventListener('click', startGame);
    pauseBtn.addEventListener('click', togglePause);
  </script>
</body>
</html>
