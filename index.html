<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Bassist's Game</title>
  <style>
    body { font-family: Arial, sans-serif; text-align:center; margin-top:30px; }
    h1 { font-size: 42px; margin-bottom: 10px; }
    #note { font-size: 40px; margin:20px; }
    #result { font-size: 24px; margin:15px; }
    #score { font-size: 20px; margin:20px; }
    #timer { font-size: 18px; color: darkred; margin:10px; }
    button, select { padding:10px 20px; font-size:18px; margin: 5px; }
    .progress-container { width: 300px; height: 20px; background: #ddd; margin: 10px auto; border-radius: 10px; overflow: hidden; }
    .progress-bar { height: 100%; background: #e74c3c; width: 100%; transition: width 1s linear; }
  </style>
</head>
<body>
  <h1>Bassist's Game</h1>

  <div>
    Instrument: 
    <select id="instrument">
      <option value="4">Bass 4 Strings (EADG)</option>
      <option value="5" selected>Bass 5 Strings (BEADG)</option>
    </select>
  </div>

  <div>
    Difficulty: 
    <select id="difficulty">
      <option value="10000">Very Easy (10s)</option>
      <option value="6000">Easy (6s)</option>
      <option value="4000">Intermediate (4s)</option>
      <option value="3000" selected>Advanced (3s)</option>
      <option value="2000">Ass Kicker (2s)</option>
    </select>
  </div>

  <div id="note">Press Start</div>
  <div id="result"></div>
  <div id="timer"></div>
  <div class="progress-container"><div class="progress-bar" id="progressBar"></div></div>
  <div id="score"></div>

  <button onclick="startGame()">Start Game</button>
  <button onclick="togglePause()">Pause / Resume</button>

  <script>
    const noteNames = ["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"];
    let fretboard = [];
    let audioCtx, analyser, dataArray, source;
    let target = null, round = 0, score = 0;
    let paused = false, gameActive = false, timeoutHandle = null, timerInterval = null;
    let timeLeft = 0, totalTime = 0;

    function buildFretboard(type){
      const strings = (type==="5")
        ? [ {name:"B",freq:30.87}, {name:"E",freq:41.20}, {name:"A",freq:55.00}, {name:"D",freq:73.42}, {name:"G",freq:98.00} ]
        : [ {name:"E",freq:41.20}, {name:"A",freq:55.00}, {name:"D",freq:73.42}, {name:"G",freq:98.00} ];
      fretboard = [];
      for (let s of strings){
        for (let fret=0; fret<=12; fret++){
          let freq = s.freq * Math.pow(2, fret/12);
          let n = noteNames[Math.round(12 * Math.log2(freq/16.35)) % 12];
          fretboard.push({string:s.name, fret:fret, note:n, freq:freq});
        }
      }
    }

    async function initMic(){
      if(!audioCtx){
        audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        let stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        source = audioCtx.createMediaStreamSource(stream);
        analyser = audioCtx.createAnalyser();
        analyser.fftSize = 2048;
        dataArray = new Float32Array(analyser.fftSize);
        source.connect(analyser);
      }
    }

    function autoCorrelate(buf, sampleRate) {
      let SIZE = buf.length, rms = 0;
      for (let i=0;i<SIZE;i++) rms += buf[i]*buf[i];
      rms = Math.sqrt(rms/SIZE);
      if (rms<0.01) return -1;
      let r1=0,r2=SIZE-1,thres=0.2;
      for (let i=0;i<SIZE/2;i++) if (Math.abs(buf[i])<thres) { r1=i; break;}
      for (let i=1;i<SIZE/2;i++) if (Math.abs(buf[SIZE-i])<thres) { r2=SIZE-i; break;}
      buf = buf.slice(r1,r2);
      SIZE = buf.length;
      let c = new Array(SIZE).fill(0);
      for (let i=0;i<SIZE;i++) for (let j=0;j<SIZE-i;j++) c[i]+=buf[j]*buf[j+i];
      let d=0; while (c[d]>c[d+1]) d++;
      let maxval=-1, maxpos=-1;
      for (let i=d;i<SIZE;i++){ if (c[i]>maxval){ maxval=c[i]; maxpos=i;}}
      let T0=maxpos;
      return sampleRate/T0;
    }

    async function startGame(){
      buildFretboard(document.getElementById("instrument").value);
      score = 0; round = 0; gameActive = true; paused = false;
      document.getElementById("score").innerText = `Score: 0 / 0`;
      await initMic();
      nextRound();
    }

    function nextRound(){
      if (!gameActive || paused) return;
      if (round >= 35){
        document.getElementById("note").innerText="Game Over!";
        document.getElementById("result").innerText=`Final Score: ${score} / ${round}`;
        document.getElementById("timer").innerText="";
        document.getElementById("progressBar").style.width="0%";
        gameActive = false;
        return;
      }
      target = fretboard[Math.floor(Math.random()*fretboard.length)];
      round++;
      document.getElementById("note").innerText = `${target.note} on ${target.string} string`;
      document.getElementById("result").innerText = "Play now!";
      
      totalTime = parseInt(document.getElementById("difficulty").value);
      timeLeft = totalTime/1000;
      document.getElementById("timer").innerText = `Time left: ${timeLeft}s`;
      document.getElementById("progressBar").style.width="100%";
      
      clearInterval(timerInterval);
      timerInterval = setInterval(()=>{
        timeLeft -= 1;
        if (timeLeft>=0){
          document.getElementById("timer").innerText = `Time left: ${timeLeft}s`;
          document.getElementById("progressBar").style.width = (timeLeft*1000/totalTime*100) + "%";
        }
      },1000);

      clearTimeout(timeoutHandle);
      timeoutHandle = setTimeout(()=>{
        document.getElementById("result").innerText="⏰ Timeout / No sound";
        playBeep("wrong");
        setTimeout(nextRound,1000);
      }, totalTime);
    }

    function checkNote(){
      if (!gameActive || paused) return;
      analyser.getFloatTimeDomainData(dataArray);
      let pitch = autoCorrelate(dataArray,audioCtx.sampleRate);
      if (pitch==-1) return;

      let closest = null, minDiff=1e9;
      for (let fb of fretboard){
        let diff = Math.abs(fb.freq - pitch);
        if (diff<minDiff){ minDiff=diff; closest=fb; }
      }
      let played = closest.note;
      let targetNote = target.note;
      let diffFromTarget = Math.abs(target.freq - pitch);

      if (played===targetNote && diffFromTarget <= 10){
        score++;
        document.getElementById("result").innerText=`✅ Correct! ${played} (${pitch.toFixed(1)} Hz)`;
        document.getElementById("score").innerText = `Score: ${score} / ${round}`;
        playBeep("correct");
        clearTimeout(timeoutHandle);
        clearInterval(timerInterval);
        setTimeout(nextRound,500);
      } else {
        document.getElementById("result").innerText=`❌ Wrong: ~${played} (${pitch.toFixed(1)} Hz), target ${targetNote}`;
        playBeep("wrong");
      }
    }

    function togglePause(){
      paused = !paused;
      if (paused){
        clearTimeout(timeoutHandle);
        clearInterval(timerInterval);
        document.getElementById("result").innerText="⏸ Paused";
      } else {
        document.getElementById("result").innerText="▶ Resumed";
        setTimeout(nextRound,1000);
      }
    }

    function playBeep(type="correct"){
      const ctx = new (window.AudioContext || window.webkitAudioContext)();
      const osc = ctx.createOscillator();
      const gain = ctx.createGain();
      osc.connect(gain);
      gain.connect(ctx.destination);
      osc.type = "sine";
      if (type==="correct"){ osc.frequency.value = 880; gain.gain.value = 0.1; }
      else { osc.frequency.value = 220; gain.gain.value = 0.15; }
      osc.start();
      osc.stop(ctx.currentTime + 0.2);
    }

    // check input often
    setInterval(()=>{ if(gameActive && !paused) checkNote(); },200);
  </script>
</body>
</html>
